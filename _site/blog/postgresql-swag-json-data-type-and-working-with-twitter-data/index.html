<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <meta charset="utf-8">
  <title>
    
      PostgreSQL SWAG: JSON data type and working with Twitter data &ndash;
    
    Bibhas Debnath
  </title>

  <meta name="author" content="Bibhas Debnath" />
  <meta name="description" content="Bibhas Debnath, developer from Kolkata, India." />

  <link rel="alternate" type="application/rss+xml" href="/atom.xml" />

  <link rel="stylesheet" href="/css/base.css" type="text/css" media="screen, projection" />
  <link media="only screen and (max-device-width: 480px)" href="/css/iphone.css" type="text/css" rel="stylesheet" />
  <link media="only screen and (device-width: 768px)" href="/css/iphone.css" type="text/css" rel="stylesheet" />
  <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="/css/app.css" type="text/css" media="screen, projection" />

  <script type="text/javascript" src="/js/jquery.min.js"></script>

  
  <link rel="stylesheet" href="/css/pygments.css" type="text/css" />
  <link rel="stylesheet" href="/css/shCore.css" type="text/css" media="screen, projection" />
  <script type="text/javascript" src="/js/shCore.js"></script>
  <script type="text/javascript" src="/js/shBrushPlain.js"></script>
  <script type="text/javascript" src="/js/shBrushJScript.js"></script>
  

  

  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  <script type="text/javascript" src="https://apis.google.com/js/plusone.js"></script>
  <script type="text/javascript" src="/js/application.js"></script>
</head>

<body>
  <section class="sidebar" align="right">
    <a href="/">
      <img src="http://www.gravatar.com/avatar/ffbd494728961d8baf2c7404dc420152?s=150" height="75" width="75" class="avatar" />
    </a>

    <section class="name">
      <a href="/">
        <span id="fname">Bibhas</span><br>
        <span id="lname">Debnath</span>
      </a>
    </section>

    <section class="meta">
      <a href="https://github.com/iambibhas" target="_blank"><img src="/images/github.png" /></a>
      <a href="https://twitter.com/pythonerd" target="_blank"><img src="/images/twitter.png"></a>
      <a href="/atom.xml"><img src="/images/rss.png" /></a>
    </section>

    <section class="sections">
      <ul>
        <li><a href="/about-me/">about</a></li>
        <li><a href="/blog/">posts</a></li>
        <li><a href="/crypt/">Generate Hashes</a></li>
        <li><a href="/search/all/">Moderated Search</a></li>
      </ul>
    </section>
    <section class="sections">
        <a href="https://twitter.com/pythonerd" class="twitter-follow-button" data-show-count="false" data-size="large">Follow @pythonerd</a>
    </section>
    <section class="sections">
        <a href="http://stackexchange.com/users/94480/bibhas">
            <img src="http://stackexchange.com/users/flair/94480.png" width="208" height="58" alt="profile for Bibhas on Stack Exchange, a network of free, community-driven Q&amp;A sites" title="profile for Bibhas on Stack Exchange, a network of free, community-driven Q&amp;A sites" />
        </a>
    </section>
    <section id="gittip">

    </section>
  </section>

  <section class="content">
  <h1>
    <a href="/blog/postgresql-swag-json-data-type-and-working-with-twitter-data/">PostgreSQL SWAG: JSON data type and working with Twitter data</a>
  </h1>

  <section class="byline">
    June 11, 2014
  </section>

  <p>When working on side projects that deal with 3rd party data, how much time do you spend on figuring out the database schema? Not an insignificant amount. You don&rsquo;t use a DBMS you say? Good luck parsing the data files and querying them.</p>

<p>I&rsquo;m not going to start a DBMS comparison. I&rsquo;ve spent a lot of time fiddling with structred data and PostgreSQL has been really kind to me. It&rsquo;s stable, <em>really</em> feaure rich and it can literally do <em>anything</em>. You want to setup a cluster? Replication? Crunch geo spatial data? parse Gigabytes of CSV files? And want to do all of these really fast? Then PostgreSQL is for you, it can do all that and more out of the box. Just today a friend told me that PostgreSQL parsed and imported his 4.3GB CSV file in under 10 minutes. I&rsquo;m happy with that performance.</p>

<p>We at KLP work with huge amount of data on daily basis and PostgreSQL has been helping us really well on our job. We&rsquo;ve recently migrated all the databases to PostgreSQL 9.3 because of the native support for PostGIS and some more interesting features, I&rsquo;ve written about some of them below. :)</p>

<p>You&rsquo;ve probably heard about PostgreSQL&rsquo;s <a href="http://www.postgresql.org/docs/9.3/static/functions-json.html">JSON data type</a> recently. This has made it possible to work with both structured and schema-less data. For example, I&rsquo;ll talk about Twitter data here. As you know, Twitter provides their data from API in JSON format. And till now, if I ever had to work with Twitter data, I had to write a quick db schema, create a table, then parse the incoming JSON, insert it in the said table and then work with it. Now the provess is a bit faster. ;)</p>

<p>First, I&rsquo;ll create couple of small tables -</p>

<pre><code>CREATE TABLE tweet
(
    tid character varying NOT NULL,
    data json,
    CONSTRAINT tid_pkey PRIMARY KEY (tid)
)

CREATE TABLE word
(
    id bigserial NOT NULL,
    text character varying(100),
    CONSTRAINT id_pkey PRIMARY KEY (id)
)
</code></pre>

<p><code>tid</code> field will store the id of the tweet and <code>data</code> field will store the json body of the tweet. The table <code>word</code> is to store the list of words I need to search for on Twitter and gather the sample data.</p>

<p>Here is a sample script I used to quickly gather about 24k tweets. It&rsquo;s not at all perfect and you should not use it to gather data. It doesn&rsquo;t even use the <code>since_id</code> param for the search API endpoint.</p>

<pre><code>import twitter
import json
import psycopg2

api = twitter.Twitter(auth=twitter.OAuth('', '', '', ''))

conn = psycopg2.connect("dbname=tweets user=bibhas password=forgotit")
cur = conn.cursor()

cur.execute('SELECT text from word')
terms = cur.fetchall()
if terms:
    for t in terms:
        tweets = api.search.tweets(q=t, lang='en', count=100)
        for s in tweets['statuses']:
            cur.execute("SELECT * FROM tweet WHERE tid='%s'", (s['id'], ))

            # ignore the duplicate and RT-like tweets
            if cur.fetchone() is not None or s['text'].find('RT @') &gt;= 0:
                continue

            cur.execute("INSERT INTO tweet (tid, data) VALUES (%s, %s)", (s['id'], json.dumps(s), ))
        conn.commit()

cur.close()
conn.close()
</code></pre>

<p>I ran this script as a cron job for few hours and I had the required data. Now if I query the table, this is what it looks like -</p>

<p><img src="/uploads/tweets-json.jpg" alt="JSON data in PostgreSQL" /></p>

<p>So, no schema specific to the tweet&rsquo;s JSON structure and we got the data in the database. Now let&rsquo;s try to query the data and see what happens.</p>

<p>Let&rsquo;s try to fetch all the tweet texts(I&rsquo;ll use <code>explain analyze</code> on all the queries for showing the performace) -</p>

<pre><code>tweets=# explain analyze select tid, data-&gt;&gt;'text' from tweet;
                                                 QUERY PLAN
-------------------------------------------------------------------------------------------------------------
 Seq Scan on tweet  (cost=0.00..4254.06 rows=20325 width=51) (actual time=0.169..458.198 rows=20335 loops=1)
 Total runtime: 459.121 ms
</code></pre>

<p>A bit slow for 20k records, but we&rsquo;ll try and fix that later. Let&rsquo;s try a <code>WHERE</code> clause on a JSON property -</p>

<pre><code>tweets=# explain analyze select tid, data#&gt;&gt;'{user,screen_name}', data-&gt;&gt;'text' from tweet where data-&gt;&gt;'text' like '%world cup%';
                                               QUERY PLAN
--------------------------------------------------------------------------------------------------------
 Seq Scan on tweet  (cost=0.00..4384.70 rows=2 width=51) (actual time=10.700..481.758 rows=510 loops=1)
   Filter: ((data -&gt;&gt; 'text'::text) ~~ '%world cup%'::text)
   Rows Removed by Filter: 20202
 Total runtime: 481.825 ms
(4 rows)
</code></pre>

<p>and if I try case insensitice matching -</p>

<pre><code>tweets=# explain analyze select tid, data#&gt;&gt;'{user,screen_name}', data-&gt;&gt;'text' from tweet where UPPER(data-&gt;&gt;'text') like UPPER('%world cup%');
                                               QUERY PLAN
--------------------------------------------------------------------------------------------------------
 Seq Scan on tweet  (cost=0.00..4436.49 rows=2 width=51) (actual time=7.983..642.647 rows=3563 loops=1)
   Filter: (upper((data -&gt;&gt; 'text'::text)) ~~ '%WORLD CUP%'::text)
   Rows Removed by Filter: 17149
 Total runtime: 642.887 ms
(4 rows)
</code></pre>

<p>Now let&rsquo;s try to find all the useful tweets, those that have been favorited more than, let&rsquo;s say 5 times -</p>

<pre><code>tweets=# explain analyze select tid, data#&gt;&gt;'{user,screen_name}', data-&gt;&gt;'favorite_count' from tweet where CAST(data-&gt;&gt;'favorite_count' AS integer) &gt; 5;
                                               QUERY PLAN
---------------------------------------------------------------------------------------------------------
 Seq Scan on tweet  (cost=0.00..5202.05 rows=7939 width=51) (actual time=2.727..557.297 rows=27 loops=1)
   Filter: (((data -&gt;&gt; 'favorite_count'::text))::integer &gt; 5)
   Rows Removed by Filter: 23787
 Total runtime: 557.338 ms
(4 rows)
</code></pre>

<p> <code>data-&gt;&gt;'favorite_count'</code> returns the count as <code>text</code> and we <code>CAST()</code> it as integer and use it for comparing.</p>

<p> Now let&rsquo;s try to fetch the geo enabled tweets that has the text &lsquo;home&rsquo; in it (:P) -</p>

<pre><code> tweets=# explain analyze select tid, data#&gt;&gt;'{user,screen_name}', data-&gt;&gt;'text', data-&gt;&gt;'geo' from tweet where data-&gt;&gt;'geo' &lt;&gt; '' and UPPER(data-&gt;&gt;'text') like UPPER('%home%');
                                               QUERY PLAN
---------------------------------------------------------------------------------------------------------
 Seq Scan on tweet  (cost=0.00..5302.47 rows=192 width=51) (actual time=28.156..549.844 rows=8 loops=1)
   Filter: (((data -&gt;&gt; 'geo'::text) &lt;&gt; ''::text) AND (upper((data -&gt;&gt; 'text'::text)) ~~ '%HOME%'::text))
   Rows Removed by Filter: 24172
 Total runtime: 549.886 ms
(4 rows)
</code></pre>

<p>Here the <code>geo</code> field will return GeoJSON like <code>{"type": "Point", "coordinates": [43.6482035, -79.3886928]}</code>. If you want to extract the lat, long directly, you can do this -</p>

<pre><code>tweets=# explain analyze select tid, data#&gt;&gt;'{user,screen_name}', data-&gt;&gt;'text', data-&gt;'geo'-&gt;'coordinates'-&gt;0 as lat, data-&gt;'geo'-&gt;'coordinates'-&gt;1 as lon from tweet where data-&gt;&gt;'geo' &lt;&gt; '' and UPPER(data-&gt;&gt;'text') like UPPER('%home%');
                                               QUERY PLAN
---------------------------------------------------------------------------------------------------------
 Seq Scan on tweet  (cost=0.00..5304.87 rows=192 width=51) (actual time=1.220..537.186 rows=8 loops=1)
   Filter: (((data -&gt;&gt; 'geo'::text) &lt;&gt; ''::text) AND (upper((data -&gt;&gt; 'text'::text)) ~~ '%HOME%'::text))
   Rows Removed by Filter: 24172
 Total runtime: 537.205 ms
(4 rows)
</code></pre>

<p>These are numbers I can work with.</p>

<p>One of the major reasons to work with PostgreSQL is <a href="http://postgis.net/">PostGIS</a>. <em>Really</em> fast geo data parsing and querying is someone everyone who works with geo data, craves. So let&rsquo;s try to find all the tweets in my store which were created withing 5km of my location, e.g. <code>13.004616, 77.620176</code> -</p>

<pre><code>explain ANALYZE
SELECT tmp_table.tid,
   tmp_table.screen_name,
   tmp_table.text
FROM
  (SELECT tid,
    data-&gt;'user'-&gt;&gt;'screen_name' AS screen_name,
    data-&gt;&gt;'text' AS text,
    CAST(data#&gt;&gt;'{geo,coordinates,0}' AS double PRECISION) AS lat,
    CAST(data#&gt;&gt;'{geo,coordinates,1}' AS double PRECISION) AS lon
   FROM tweet
   WHERE data-&gt;&gt;'geo' &lt;&gt; '') AS tmp_table
WHERE ST_Distance(
    ST_MakePoint(tmp_table.lon, tmp_table.lat)::geography,
    ST_MakePoint(77.620176, 13.004616)::geography
) &lt; 5000;
</code></pre>

<p>that yields this -</p>

<pre><code>                                                QUERY PLAN
---------------------------------------------------------------------------------
 Seq Scan on tweet  (cost=0.00..12667.35 rows=8631 width=51) (actual time=311.740..617.514 rows=2 loops=1)
   Filter: (((data -&gt;&gt; 'geo'::text) &lt;&gt; ''::text) AND (_st_distance((st_makepoint(((data #&gt;&gt; '{geo,coordinates,1}'::text[]))::double precision, ((data #&gt;&gt; '{geo,coordinates,0}'::text[]))::double precision))::geography, '0101000020E6100000E770ADF6B0675340A11342075D022A40'::geography, 0::double precision, true) &lt; 5000::double precision))
   Rows Removed by Filter: 26013
 Total runtime: 617.561 ms
(4 rows)
</code></pre>

<p>That&rsquo;s fairly fast for me.</p>

<p>Just for reference, <a href="http://postgis.net/docs/ST_Distance.html">ST_Distance</a> and <a href="http://postgis.net/docs/ST_MakePoint.html">ST_MakePoint</a> docs are pretty handy.</p>

<p>All the above queries just showed that we can query a fairly sized db using JSON data type without much time different between complex queries. My cron job for collecting tweets is still running. I&rsquo;m waiting for it to touch 1 million records. Once it does, will test on it and update this post.</p>

<p>I&rsquo;ll probably write another post on PostGIS and maybe Foursquare data. That would be fun. If you have any ideas, let me know.</p>


  <!-- TODO: bio here -->
  <section class="meta">
    <h3>Discussion, links, and tweets</h3>
    <section class="copy">
      <a href="https://twitter.com/share" class="twitter-share-button" data-via="iAmBibhas">Tweet</a>
      <div class="g-plusone" data-size="tall" data-annotation="none"></div>
    </section>
    <section style="padding-right: 20px; margin-top: 10px">
        
            <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'bee-mblog'; // required: replace example with your forum shortname
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

        
    </section>
  </section>
</section>


    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-3724476-6']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
    <script type="text/javascript">
        if(SyntaxHighlighter !== undefined){
            SyntaxHighlighter.all();
        }
    </script>

</body>

</html>
