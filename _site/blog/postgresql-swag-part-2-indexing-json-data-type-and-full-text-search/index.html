<!DOCTYPE html>
<html xmlns="//www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <meta charset="utf-8">
  <title>
    
      PostgreSQL SWAG Part 2: Indexing JSON data type and Full text search &ndash;
    
    Bibhas Debnath
  </title>

  <meta name="author" content="Bibhas Debnath" />
  <meta name="description" content="Bibhas Debnath, developer from Kolkata, India." />

  <link rel="alternate" type="application/rss+xml" href="/atom.xml" />

  <link href='//fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
  <link href='//fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="/css/base.css" type="text/css" media="screen, projection" />
  <link media="only screen and (max-device-width: 480px)" href="/css/iphone.css" type="text/css" rel="stylesheet" />
  <link media="only screen and (device-width: 768px)" href="/css/iphone.css" type="text/css" rel="stylesheet" />
  <link rel="stylesheet" href="/css/app.css" type="text/css" media="screen, projection" />

  <script type="text/javascript" src="/js/jquery.min.js"></script>

  
  <link rel="stylesheet" href="/css/pygments.css" type="text/css" />
  <link rel="stylesheet" href="/css/shCore.css" type="text/css" media="screen, projection" />
  <script type="text/javascript" src="/js/shCore.js"></script>
  <script type="text/javascript" src="/js/shBrushPlain.js"></script>
  <script type="text/javascript" src="/js/shBrushJScript.js"></script>
  

  

  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  <script type="text/javascript" src="https://apis.google.com/js/plusone.js"></script>
  <script type="text/javascript" src="/js/application.js"></script>
</head>

<body>
  <section class="sidebar" align="right">
    <a href="/">
      <img src="https://www.gravatar.com/avatar/ffbd494728961d8baf2c7404dc420152?s=150" height="75" width="75" class="avatar" />
    </a>

    <section class="name">
      <a href="/">
        <span id="fname">Bibhas</span><br>
        <span id="lname">Debnath</span>
      </a>
    </section>

    <section class="meta">
      <a href="https://github.com/iambibhas" target="_blank"><img src="/images/github.png" /></a>
      <a href="https://twitter.com/bibhasdn" target="_blank"><img src="/images/twitter.png"></a>
      <a href="/atom.xml"><img src="/images/rss.png" /></a>
    </section>

    <section class="sections">
      <ul>
        <li><a href="/about-me/">about</a></li>
        <li><a href="/blog/">posts</a></li>
        <li><a href="/crypt/">Generate Hashes</a></li>
        <li><a href="/search/all/">Moderated Search</a></li>
      </ul>
    </section>
    <section class="sections">
        <a href="https://twitter.com/bibhasdn" class="twitter-follow-button" data-show-count="false" data-size="large">Follow @bibhasdn</a>
    </section>
    <section class="sections">
        <a href="//stackexchange.com/users/94480/bibhas">
            <img src="//stackexchange.com/users/flair/94480.png" width="208" height="58" alt="profile for Bibhas on Stack Exchange, a network of free, community-driven Q&amp;A sites" title="profile for Bibhas on Stack Exchange, a network of free, community-driven Q&amp;A sites" />
        </a>
    </section>
    <section id="gittip">

    </section>
  </section>

  <section class="content">
  <h1>
    <a href="/blog/postgresql-swag-part-2-indexing-json-data-type-and-full-text-search/">PostgreSQL SWAG Part 2: Indexing JSON data type and Full text search</a>
  </h1>

  <section class="byline">
    June 14, 2014
  </section>

  <p>In my <a href="/blog/postgresql-swag-json-data-type-and-working-with-twitter-data/">last post</a> I demonstrated the use of JSON data type of PostgreSQL. But I skipped a crucial part, Indexes.</p>

<p>All my queries in last post ran on a table with about 24k rows with the JSON tweet data. That import script of mine is still running and I&rsquo;ve crossed 100k records. I&rsquo;ll run the same queries again, but this time I&rsquo;ll create indexes for the appropriate columns before querying.</p>

<p>Also, I&rsquo;ll explain briefly how you can use the full text search feature of PostgreSQL instead of using <code>LIKE</code> like I used in last blog post.</p>

<p>Let&rsquo;s first try to fetch all the tweets that have both the word &ldquo;world&rdquo; and &ldquo;cup&rdquo; in it -</p>

<pre><code>tweets=# create index "idx_text" on tweet using gin(to_tsvector('english', data-&gt;&gt;'text'));
CREATE INDEX
tweets=# analyze tweet;
ANALYZE
tweets=# explain analyze select tid, data-&gt;&gt;'text' from tweet where to_tsvector('english', data-&gt;&gt;'text') @@ to_tsquery('world &amp; cup');
                                                      QUERY PLAN
-----------------------------------------------------------------------------------------------------------------------
 Bitmap Heap Scan on tweet  (cost=61.03..8490.10 rows=3229 width=51) (actual time=4.146..358.203 rows=17037 loops=1)
   Recheck Cond: (to_tsvector('english'::regconfig, (data -&gt;&gt; 'text'::text)) @@ to_tsquery('world &amp; cup'::text))
   -&gt;  Bitmap Index Scan on idx_text  (cost=0.00..60.23 rows=3229 width=0) (actual time=3.325..3.325 rows=17037 loops=1)
         Index Cond: (to_tsvector('english'::regconfig, (data -&gt;&gt; 'text'::text)) @@ to_tsquery('world &amp; cup'::text))
 Total runtime: 358.887 ms
(5 rows)

tweets=# explain analyze select tid, data-&gt;&gt;'text' from tweet where to_tsvector('english', data-&gt;&gt;'text') @@ to_tsquery('python &amp; ruby');
                                                      QUERY PLAN
-----------------------------------------------------------------------------------------------------------------------
 Bitmap Heap Scan on tweet  (cost=28.13..91.09 rows=16 width=51) (actual time=2.969..12.769 rows=114 loops=1)
   Recheck Cond: (to_tsvector('english'::regconfig, (data -&gt;&gt; 'text'::text)) @@ to_tsquery('python &amp; ruby'::text))
   -&gt;  Bitmap Index Scan on idx_text  (cost=0.00..28.12 rows=16 width=0) (actual time=2.822..2.822 rows=114 loops=1)
         Index Cond: (to_tsvector('english'::regconfig, (data -&gt;&gt; 'text'::text)) @@ to_tsquery('python &amp; ruby'::text))
 Total runtime: 12.841 ms
(5 rows)
</code></pre>

<p>The phenomenal time difference is dependant on the number of results -</p>

<pre><code>tweets=# select count(tid) from tweet where to_tsvector('english', data-&gt;&gt;'text') @@ to_tsquery('python &amp; ruby');
 count
-------
   114
(1 row)

tweets=# select count(tid) from tweet where to_tsvector('english', data-&gt;&gt;'text') @@ to_tsquery('world &amp; cup');
 count
-------
 17037
(1 row)
</code></pre>

<p>Just remember that these queries are running on almost 4 times the records compared to the last post.</p>

<p>I think that <code>gin(to_tsvector('english', data-&gt;&gt;'text'))</code> and <code>where to_tsvector('english', data-&gt;&gt;'text') @@ to_tsquery('world &amp; cup')</code> needs some explanation.</p>

<p><code>GIN</code>(Generalized Inverted Index) and <code>GiST</code>(Generalized Search Tree) indexes are <a href="http://www.postgresql.org/docs/current/static/textsearch-indexes.html">two types of indexes</a> on PostgreSQL that can be used to speed up the text search proxess. There are merits and demerits of both. As a rule of thumb, <code>GIN</code> indexes are best for static data because lookups are faster. Hence we&rsquo;re using that.</p>

<p>It&rsquo;s important to note that if you create index for <code>to_tsvector('english', data-&gt;&gt;'text')</code> then while searching you much use the same <code>to_tsvector</code> method. If you use <code>to_tsvector(data-&gt;&gt;'text')</code>, the index might not be used.</p>

<p>The <code>to_tsvector()</code> function takes a text and breaks it up into tokens, then consults few dictionaries that recognizes those tokens and provides a more normalized <code>lexems</code> to represent the token. The stop words are also detected and ignored as they appear too frequently to be useful while searching. E.g. -</p>

<pre><code>tweets=# select to_tsvector('english', 'Fifa world cup is ongoing');
             to_tsvector
-------------------------------------
 'cup':3 'fifa':1 'ongo':5 'world':2
(1 row)
</code></pre>

<p><code>to_tsquery()</code> creates a <code>tsquery</code> value from querytext, which must consist of single tokens separated by the Boolean operators <code>&amp;</code> (AND), <code>|</code> (OR) and <code>!</code> (NOT).</p>

<pre><code>tweets=# select to_tsquery('english', 'Fifa &amp; world | cup');
        to_tsquery
--------------------------
 'fifa' &amp; 'world' | 'cup'
(1 row)
</code></pre>

<p><a href="http://www.postgresql.org/docs/9.3/static/textsearch-controls.html#TEXTSEARCH-PARSING-DOCUMENTS">PostgreSQL doc</a> has more details.</p>

<p>Then the <code>tsvector</code> is searched with the <code>tsquery</code> <a href="http://www.postgresql.org/docs/9.3/static/functions-textsearch.html">using <code>@@</code></a>.</p>

<p>Now let&rsquo;s try searching for tweets with more than 5 favorites, both with and without indexes, so that we can compare -</p>

<pre><code>tweets=# explain analyze select tid, data#&gt;&gt;'{user,screen_name}', data-&gt;&gt;'favorite_count' from tweet where CAST(data-&gt;&gt;'favorite_count' AS integer) &gt; 5;
                                                 QUERY PLAN
-------------------------------------------------------------------------------------------------------------
 Seq Scan on tweet  (cost=0.00..21121.93 rows=32322 width=51) (actual time=1.901..2103.874 rows=100 loops=1)
   Filter: (((data -&gt;&gt; 'favorite_count'::text))::integer &gt; 5)
   Rows Removed by Filter: 96865
 Total runtime: 2103.918 ms
(4 rows)

tweets=# create index "idx_fav_count" on tweet using btree(CAST(data-&gt;&gt;'favorite_count' AS integer));
CREATE INDEX
tweets=# analyze tweet;
ANALYZE
tweets=# explain analyze select tid, data#&gt;&gt;'{user,screen_name}', data-&gt;&gt;'favorite_count' from tweet where CAST(data-&gt;&gt;'favorite_count' AS integer) &gt; 5;
                                                         QUERY PLAN
-----------------------------------------------------------------------------------------------------------------------------
 Index Scan using idx_fav_count on tweet  (cost=0.30..157.46 rows=133 width=51) (actual time=0.266..16.045 rows=100 loops=1)
   Index Cond: (((data -&gt;&gt; 'favorite_count'::text))::integer &gt; 5)
 Total runtime: 16.104 ms
(3 rows)
</code></pre>

<p>As you see, creating the index took down the time from 2 seconds to about 16ms!</p>

<p>Let&rsquo;s find the tweets that has the word <code>home</code> in them and also has geo location (remember, we created index for <code>data-&gt;&gt;'text'</code> earlier) -</p>

<pre><code>tweets=# explain analyze select tid, data#&gt;&gt;'{user,screen_name}', data-&gt;&gt;'text', data-&gt;&gt;'geo' from tweet where data-&gt;&gt;'geo' &lt;&gt; '' and to_tsvector('english', data-&gt;&gt;'text') @@ to_tsquery('home');
                                                       QUERY PLAN
-------------------------------------------------------------------------------------------------------------------------
 Bitmap Heap Scan on tweet  (cost=126.35..4321.85 rows=1328 width=51) (actual time=2.095..46.272 rows=27 loops=1)
   Recheck Cond: (to_tsvector('english'::regconfig, (data -&gt;&gt; 'text'::text)) @@ to_tsquery('home'::text))
   Filter: ((data -&gt;&gt; 'geo'::text) &lt;&gt; ''::text)
   Rows Removed by Filter: 1322
   -&gt;  Bitmap Index Scan on idx_text  (cost=0.00..126.02 rows=1335 width=0) (actual time=1.006..1.006 rows=1349 loops=1)
         Index Cond: (to_tsvector('english'::regconfig, (data -&gt;&gt; 'text'::text)) @@ to_tsquery('home'::text))
 Total runtime: 46.313 ms
(7 rows)
</code></pre>

<p>From ~550ms to 46ms, that too on 4 times the records!</p>

<p>This just shows how indexing can make your life much easier if you use it correctly. :)</p>


  <!-- TODO: bio here -->
  <section class="meta">
    <h3>Discussion, links, and tweets</h3>
    <section class="copy">
      <a href="https://twitter.com/share" class="twitter-share-button" data-via="bibhasdn">Tweet</a>
      <div class="g-plusone" data-size="tall" data-annotation="none"></div>
    </section>
    <section style="padding-right: 20px; margin-top: 10px">
        
            <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'bee-mblog'; // required: replace example with your forum shortname
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

        
    </section>
  </section>
</section>



    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-3724476-6']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : '//www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
    <script type="text/javascript">
        if(SyntaxHighlighter !== undefined){
            SyntaxHighlighter.all();
        }
    </script>

</body>

</html>
